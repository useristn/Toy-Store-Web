<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Support Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>üß™ Test Support Chat System</h1>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>1. Check Authentication</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary" onclick="checkAuth()">Check Auth Token</button>
            <pre id="authResult" class="mt-2 bg-light p-2" style="min-height: 50px;"></pre>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>2. Test Customer API</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-success" onclick="testCreateSession()">Create Support Session</button>
            <pre id="sessionResult" class="mt-2 bg-light p-2" style="min-height: 50px;"></pre>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>3. Test Admin API</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-warning" onclick="testAdminSessions()">Get Admin Sessions</button>
            <pre id="adminResult" class="mt-2 bg-light p-2" style="min-height: 50px;"></pre>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>4. Test WebSocket</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-info" onclick="testWebSocket()">Test WebSocket Connection</button>
            <pre id="wsResult" class="mt-2 bg-light p-2" style="min-height: 50px;"></pre>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
function getAuthHeaders() {
    const token = localStorage.getItem('token');
    return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
}

function checkAuth() {
    const token = localStorage.getItem('token');
    const result = document.getElementById('authResult');
    if (token) {
        result.textContent = '‚úÖ Token exists: ' + token.substring(0, 50) + '...';
    } else {
        result.textContent = '‚ùå No token found. Please login first.';
    }
}

function testCreateSession() {
    const result = document.getElementById('sessionResult');
    result.textContent = '‚è≥ Creating session...';
    
    fetch('/api/support/session', {
        method: 'POST',
        headers: getAuthHeaders()
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        result.textContent = '‚úÖ Session created:\n' + JSON.stringify(data, null, 2);
    })
    .catch(error => {
        result.textContent = '‚ùå Error:\n' + error.message;
    });
}

function testAdminSessions() {
    const result = document.getElementById('adminResult');
    result.textContent = '‚è≥ Loading sessions...';
    
    fetch('/api/support/admin/sessions', {
        headers: getAuthHeaders()
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        result.textContent = '‚úÖ Sessions loaded:\n' + JSON.stringify(data, null, 2);
    })
    .catch(error => {
        result.textContent = '‚ùå Error:\n' + error.message;
    });
}

function testWebSocket() {
    const result = document.getElementById('wsResult');
    result.textContent = '‚è≥ Connecting to WebSocket...';
    
    try {
        const socket = new SockJS('/ws-support');
        const stompClient = Stomp.over(socket);
        
        stompClient.connect({}, function(frame) {
            result.textContent = '‚úÖ WebSocket connected:\n' + frame;
            setTimeout(() => {
                stompClient.disconnect();
                result.textContent += '\n\n‚úÖ Disconnected successfully';
            }, 2000);
        }, function(error) {
            result.textContent = '‚ùå WebSocket error:\n' + error;
        });
    } catch (error) {
        result.textContent = '‚ùå Error:\n' + error.message;
    }
}

// Auto check auth on load
window.addEventListener('load', checkAuth);
</script>
</body>
</html>
