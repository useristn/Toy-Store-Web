<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Support Access</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { 
            font-family: monospace; 
            white-space: pre-wrap; 
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1>üîç Debug Admin Support Access</h1>
    <p class="text-muted">C√¥ng c·ª• ki·ªÉm tra quy·ªÅn truy c·∫≠p Admin Support</p>
    
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5>Step 1: Check Token</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary" onclick="checkToken()">Check Token</button>
            <div id="tokenResult" class="test-result"></div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5>Step 2: Check User Profile & Role</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-info" onclick="checkUserProfile()">Check Profile</button>
            <div id="profileResult" class="test-result"></div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header bg-warning text-white">
            <h5>Step 3: Test Admin API Access</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-warning" onclick="testAdminAPI()">Test Admin API</button>
            <div id="apiResult" class="test-result"></div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5>Step 4: Test Page Access</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-success" onclick="testPageAccess()">Test /admin/support Access</button>
            <div id="pageResult" class="test-result"></div>
        </div>
    </div>
    
    <div class="alert alert-info mt-4">
        <h5>üí° H∆∞·ªõng d·∫´n:</h5>
        <ol>
            <li>ƒêƒÉng nh·∫≠p tr∆∞·ªõc khi ch·∫°y test</li>
            <li>Ch·∫°y t·ª´ng b∆∞·ªõc theo th·ª© t·ª±</li>
            <li>Xem k·∫øt qu·∫£ v√† l·ªói (n·∫øu c√≥)</li>
            <li>N·∫øu Step 2 kh√¥ng c√≥ role ADMIN ‚Üí C·∫ßn c·∫•p quy·ªÅn trong database</li>
            <li>N·∫øu Step 3 tr·∫£ v·ªÅ 403 ‚Üí V·∫•n ƒë·ªÅ v·ªÅ authorization</li>
        </ol>
    </div>
</div>

<script>
function checkToken() {
    const result = document.getElementById('tokenResult');
    const token = localStorage.getItem('token');
    
    if (!token) {
        result.innerHTML = '<span class="error">‚ùå Kh√¥ng t√¨m th·∫•y token\nVui l√≤ng ƒëƒÉng nh·∫≠p</span>';
        return;
    }
    
    // Decode JWT (just the payload, not verifying signature)
    try {
        const parts = token.split('.');
        const payload = JSON.parse(atob(parts[1]));
        
        const now = Math.floor(Date.now() / 1000);
        const expired = payload.exp && payload.exp < now;
        
        result.innerHTML = `<span class="success">‚úÖ Token t·ªìn t·∫°i</span>

Token (first 50 chars): ${token.substring(0, 50)}...

Decoded Payload:
${JSON.stringify(payload, null, 2)}

Expiry: ${payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'N/A'}
Status: ${expired ? '<span class="error">EXPIRED ‚ö†Ô∏è</span>' : '<span class="success">VALID ‚úÖ</span>'}
`;
    } catch (e) {
        result.innerHTML = `<span class="error">‚ùå Token kh√¥ng h·ª£p l·ªá\n${e.message}</span>`;
    }
}

function checkUserProfile() {
    const result = document.getElementById('profileResult');
    result.innerHTML = '‚è≥ ƒêang l·∫•y th√¥ng tin user...';
    
    const token = localStorage.getItem('token');
    if (!token) {
        result.innerHTML = '<span class="error">‚ùå Kh√¥ng c√≥ token. Vui l√≤ng ƒëƒÉng nh·∫≠p.</span>';
        return;
    }
    
    fetch('/api/user/profile', {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const hasAdminRole = data.roles && data.roles.some(r => r.name === 'ROLE_ADMIN' || r.name === 'ADMIN');
        
        result.innerHTML = `<span class="success">‚úÖ Profile loaded</span>

User Info:
${JSON.stringify(data, null, 2)}

Has ADMIN role: ${hasAdminRole ? '<span class="success">YES ‚úÖ</span>' : '<span class="error">NO ‚ùå</span>'}
${!hasAdminRole ? '\n‚ö†Ô∏è KH√îNG C√ì ROLE ADMIN! C·∫ßn c·∫•p quy·ªÅn trong database.' : ''}
`;
    })
    .catch(error => {
        result.innerHTML = `<span class="error">‚ùå L·ªói khi l·∫•y profile:\n${error.message}</span>`;
    });
}

function testAdminAPI() {
    const result = document.getElementById('apiResult');
    result.innerHTML = '‚è≥ ƒêang test API /api/support/admin/sessions...';
    
    const token = localStorage.getItem('token');
    if (!token) {
        result.innerHTML = '<span class="error">‚ùå Kh√¥ng c√≥ token. Vui l√≤ng ƒëƒÉng nh·∫≠p.</span>';
        return;
    }
    
    fetch('/api/support/admin/sessions', {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        const status = response.status;
        const statusText = response.statusText;
        
        if (status === 200) {
            return response.json().then(data => ({
                status, statusText, data, success: true
            }));
        } else {
            return response.text().then(text => ({
                status, statusText, error: text, success: false
            }));
        }
    })
    .then(res => {
        if (res.success) {
            result.innerHTML = `<span class="success">‚úÖ API Success</span>

Status: ${res.status} ${res.statusText}

Response:
${JSON.stringify(res.data, null, 2)}
`;
        } else {
            let diagnosis = '';
            if (res.status === 401) {
                diagnosis = '\n‚ö†Ô∏è UNAUTHORIZED: Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n';
            } else if (res.status === 403) {
                diagnosis = '\n‚ö†Ô∏è FORBIDDEN: Kh√¥ng c√≥ quy·ªÅn ADMIN';
            }
            
            result.innerHTML = `<span class="error">‚ùå API Failed</span>

Status: ${res.status} ${res.statusText}${diagnosis}

Response:
${res.error}
`;
        }
    })
    .catch(error => {
        result.innerHTML = `<span class="error">‚ùå Network Error:\n${error.message}</span>`;
    });
}

function testPageAccess() {
    const result = document.getElementById('pageResult');
    result.innerHTML = '‚è≥ ƒêang test truy c·∫≠p /admin/support...';
    
    fetch('/admin/support', {
        method: 'GET',
        redirect: 'manual'
    })
    .then(response => {
        if (response.type === 'opaqueredirect') {
            result.innerHTML = `<span class="error">‚ùå B·ªã redirect (c√≥ th·ªÉ v·ªÅ /login)</span>

Status: Redirect
‚ö†Ô∏è Trang admin/support ƒëang redirect. Ki·ªÉm tra:
1. SecurityConfig c√≥ permit /admin/** kh√¥ng?
2. C√≥ middleware n√†o ch·∫∑n kh√¥ng?
`;
        } else if (response.ok) {
            result.innerHTML = `<span class="success">‚úÖ Truy c·∫≠p th√†nh c√¥ng</span>

Status: ${response.status} ${response.statusText}
Trang admin/support c√≥ th·ªÉ truy c·∫≠p
`;
        } else {
            result.innerHTML = `<span class="error">‚ùå L·ªói truy c·∫≠p</span>

Status: ${response.status} ${response.statusText}
`;
        }
    })
    .catch(error => {
        result.innerHTML = `<span class="error">‚ùå Error:\n${error.message}</span>`;
    });
}

// Auto check token on load
window.addEventListener('load', () => {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi test.');
    }
});
</script>
</body>
</html>
